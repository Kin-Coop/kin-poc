<?php

/**
 * Implements hook_cron().
 */
function kin_forum_notify_cron() {
  $digest_service = \Drupal::service('kin_forum_notify.group_forum_digest');
  $digest_service->sendDailyDigest();
}

/**
 * Implements hook_mail().
 */
  function kin_forum_notify_mail($key, &$message, $params) {
    switch ($key) {
      case 'group_forum_digest':
        $first_name = $params['first_name'] ?? 'Friend';
        $comment_count = $params['comment_count'];
        $forum_url = $params['node']->toUrl('canonical', ['absolute' => TRUE])->toString();

        $message['subject'] = t('Daily Forum Digest - @count new comments', ['@count' => $comment_count]);

        // Set headers for HTML email
        $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';

        // HTML version
        $html_body = "
        <html>
        <body>
          <p>Dear {$first_name},</p>

          <p>There have been <strong>{$comment_count}</strong> new comments in your household forum today.</p>

          <p><a href=\"{$forum_url}\" style=\"background-color: #007cba; color: white; padding: 10px 15px; text-decoration: none; border-radius: 3px;\">View the discussion</a></p>

          <p>Best regards,<br>
          Kin Team</p>
        </body>
        </html>
      ";

        $message['body'][] = $html_body;
        break;
    }
  }

