<?php

use Drupal\user\UserInterface;

/**
 * Implements hook_user_login().
 */
/*
function kin_welcome_user_login(UserInterface $account) {
  // Check if this user has never seen the welcome modal
  $has_seen_modal = \Drupal::service('user.data')->get(
    'kin_welcome',
    $account->id(),
    'has_seen_welcome_modal'
  );

  // If they haven't seen the modal, set the initial login flag
  if (!$has_seen_modal) {
    \Drupal::service('user.data')->set(
      'kin_welcome',
      $account->id(),
      'initial_login',
      TRUE
    );
  }
}
*/

/**
 * Implements hook_page_attachments().
 */
function kin_welcome_page_attachments(array &$attachments) {
  $current_user = \Drupal::currentUser();

  // Only for logged in users
  if ($current_user->isAnonymous()) {
    return;
  }

  // Only trigger on node 5 (the homepage)
  $route_name = \Drupal::routeMatch()->getRouteName();
  $node = \Drupal::routeMatch()->getParameter('node');

  $is_homepage = FALSE;

  if ($route_name === 'entity.node.canonical' && $node) {
    $node_id = is_object($node) ? $node->id() : $node;
    if ($node_id == 5) {
      $is_homepage = TRUE;
    }
  }

  if (!$is_homepage) {
    return;
  }

  $user_data = \Drupal::service('user.data');
  $uid = $current_user->id();

  // Get contact ID
  /** @var \Drupal\kin_civi\Service\Utils $utils */
  $utils = \Drupal::service('kin_civi.utils');
  $cid = $utils->kin_civi_get_contact_id($uid);

  // Check both flags
  //$initial_login = $user_data->get('kin_welcome', $uid, 'initial_login');
  $has_seen_modal = $user_data->get('kin_welcome', $uid, 'has_seen_welcome_modal');
  //$has_seen_modal = 0;

  // Only show if it's their initial login and they haven't seen the modal
  //if (!$initial_login || $has_seen_modal) {
    //return;
  //}

  if($has_seen_modal) {
    return;
  }

  // Reset the initial login flag and mark modal as seen
  $user_data->set('kin_welcome', $uid, 'initial_login', FALSE);
  $user_data->set('kin_welcome', $uid, 'has_seen_welcome_modal', TRUE);

  // Load slide config
  $config = \Drupal::config('kin_welcome.slides');
  $slides = $config->get('slides') ?? [];

  // Build slides data for JavaScript
  $slides_data = [];
  foreach ($slides as $key => $slide) {
    $slides_data[] = [
      'title' => $slide['title'] ?? '',
      'body' => $slide['body'] ?? '',
      'link_text' => $slide['link_text'] ?? NULL,
      'link_url' => $slide['link_url'] ?? NULL,
      'currentContactId' => $cid,
    ];
  }

  // Generate CSRF token for the mark shown endpoint
  $csrf_token = \Drupal::service('csrf_token')->get('kin-welcome/mark-shown');

  // Attach library and pass slide data to JavaScript
  $attachments['#attached']['library'][] = 'kin_welcome/welcome_modal';
  $attachments['#attached']['drupalSettings']['kinWelcome'] = [
    'slides' => $slides_data,
    'markShownUrl' => '/kin-welcome/mark-shown',
    'csrfToken' => $csrf_token,
  ];
}
